<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      i18n:domain="plonesurvey">
<body>
<div 
     metal:define-macro="question"
     tal:define="matrix_questions question/getQuestions;
                 qid question/getId;
                 helpid string:${qid}_help;
                 error errors/?qid|nothing"
     tal:condition="matrix_questions">

    <h2 class="questionTitle">
        <label tal:attributes="for qid"
               tal:content="question/Title" />
    </h2>
    <div class="formHelp"
         tal:attributes="id helpid"
         tal:content="question/Description" />

    <table border="1" 
           tal:define="hasOptions python: hasattr(question, 'getQuestionOptions') and len(question.getQuestionOptions()) > 0;
                       options question/getQuestionOptions;
                       input_type question/getInputType">
        <thead>
        <tr>
            <th 
                i18n:translate="label_matrix_question">Question</th>
            <th 
                tal:condition="python:input_type in ['radio', 'checkbox', 'text','area']"
                tal:repeat="option options"
                tal:content="python:test(same_type(options, ()), option, hasattr(options, 'getValue') and options.getValue(option))"/>
            <th 
                  tal:condition="python:input_type not in ['radio', 'checkbox', 'text', 'area']">
                Select Option
            </th>
        </tr>
        </thead>
        
        <tr tal:repeat="matrix_question matrix_questions">
            <div tal:omit-tag=""
                 tal:define="mqid matrix_question/getId;">
                <td >
                    <label tal:content="matrix_question/Title"
                           tal:attributes="for mqid"/>
                    <span class="fieldRequired"
                          title="Required"
                          tal:condition="matrix_question/getRequired"
                          i18n:translate="Required">(Required)</span>
                </td>
                <td tal:condition="python:input_type == 'radio'"
                    tal:repeat="option options"
                    align="center">
                    <span 
                           tal:define="answer python:request.get(str(qid) + '-' + str(mqid), None) or matrix_question.getAnswerFor(member_id);
                                       value option;
                                       name string:${qid}-${mqid};
                                       id string:${qid}-${mqid}-${repeat/option/number};
                                       checked python:str(option) == str(answer);
                                       tabindex tabindex/next;"
                           tal:condition="checked" >X</span>&nbsp;
                </td>
                <td tal:define="null_value question/getNullValue"
                    tal:condition="python:input_type == 'selectionBox'">
                    <span tal:condition="python:question.getInputType() == 'selectionBox' and hasOptions"
                            tal:define="answer python:request.get(str(qid) + '-' + str(mqid), None) or matrix_question.getAnswerFor(member_id);"
                            tal:attributes="name string:${qid}-${mqid};
                                            id string:${qid}-${mqid};
                                            tabindex tabindex/next;">
                       <span tal:repeat="option question/getQuestionOptions">
                        <span
                                tal:define="value option;
                                                selected python:answer and option == answer;"
                                tal:condition="selected"
                                tal:content="python:test(same_type(options, ()), option, hasattr(options, 'getValue') and options.getValue(option))" />
                       </span>
                    </span>
                </td>
                <td tal:condition="python:input_type == 'multipleSelect'">
                    <span tal:condition="python: question.getInputType() == 'multipleSelect' and hasOptions"
                            tal:define="answer python:request.get(str(qid) + '-' + str(mqid), None) or matrix_question.getAnswerFor(member_id);"
                            multiple="multiple"
                            tal:attributes="name string:${qid}-${mqid}; 
                                            id string:${qid}-${mqid}; 
                                            tabindex tabindex/next;">
                        <span tal:repeat="option question/getQuestionOptions">
                         <span
                                value="option"
                                tal:define="value option;
                                                selected python:answer and option in answer;"
                                tal:condition="selected"
                                tal:content="option">option</span>
                        </span>
                    </span>
                </td>
                <td tal:condition="python:input_type == 'text' or input_type == 'area'"
		    tal:define="risposte python:matrix_question.getAnswerFor(member_id);
		    		risp python: test(risposte <> None and (same_type(risposte, []) or same_type(risposte, ())), risposte, [risposte for x in range(len(question.getQuestionOptions()))] )"

                    tal:repeat="option question/getQuestionOptions">
                    <span tal:condition="python:input_type == 'text'" type="text"
                           name="answer"
                           value="option"
                           tal:define="numb repeat/option/index;
			   	       campo python:risp[numb];
			               answer python:request.get(str(qid) + '-' + str(mqid) + '-' + str(numb), None) or campo;
                                       value answer;
                                           name string:${qid}-${mqid};
                                           id string:${qid}-${mqid}-${repeat/option/number};
                                           tabindex tabindex/next;"
                           tal:content="value" />
                    <span tal:condition="python:input_type == 'area'"
                           name="answer"
                           tal:define="numb repeat/option/index;
                                       campo python:risp[numb];
                                       answer python:request.get(str(qid) + '-' + str(mqid) + '-' + str(numb), None) or campo;
                                       value answer;
                                           name string:${qid}-${mqid};
                                           id string:${qid}-${mqid}-${repeat/option/number};
                                           tabindex tabindex/next;"
			   tal:content="answer" >valore</span>
                </td>
                <td tal:condition="python:input_type == 'checkbox'"
                    tal:repeat="option question/getQuestionOptions">
                    <span 
                           name="answer"
                           value="option"
                           tal:define="answer python:request.get(str(qid) + '-' + str(mqid), None) or matrix_question.getAnswerFor(member_id);
                                       value option; 
                                           name string:${qid}-${mqid};
                                           id string:${qid}-${mqid}-${repeat/option/number};
                                           checked python: answer and option in answer;
                                           tabindex tabindex/next;"
                           tal:content="value" />
                </td>
            </div>
        </tr>
    </table>

</div>
<dl metal:define-macro="display">
    <dt tal:content="question/Title" />
    <div tal:omit-tag="" tal:condition="python:not(same_type(question.getAnswerFor(member_id), []))">
     <dd tal:content="python:question.getAnswerFor(member_id)" />
    </div>
    <div tal:omit-tag="" tal:condition="python:same_type(question.getAnswerFor(member_id), [])">
     <dd>
      <span tal:omit-tag="" tal:repeat="valore python:question.getAnswerFor(member_id)">
       <span tal:content="valore" /> <br />
      </span>
    </dd>
    </div>
    <div tal:condition="python:hasattr(question, 'getCommentType') and question.getCommentType()"
         tal:omit-tag="">
        <dt>Comment</dt>
        <dd tal:content="python: question.getCommentsFor(member_id) or 'No Comment'" />
    </div>
</dl>
</body>
</html>
